<!DOCTYPE html>
<html>

<head>
  <style>
    html,
    body {
      padding: 10px 20px;
      margin: 0;
    }

    button {
      margin: 4pt;
    }

    h1 {
      font-size: 22px;
      margin-top: 30px;
      margin-bottom: 20px;
    }

    #outer-container {
      position: relative;
    }

    #content {
      max-width: 920px;
      font-size: 17px;
      line-height: 27px;
    }

    ul {
      padding: 0;
    }

    li {
      list-style: none;
    }




    #labels td,
    thead {
      font-family: sans-serif;
      font-weight: bold;
    }

    li tr+tr {
      position: relative;
    }

    li tr+tr:after {
      content: '';
      display: block;
      width: 100%;
      border-bottom: 1px solid #ccc;
      position: absolute;
      top: 0;
      left: 0;
    }

    li td ul {
      margin: 10px 0;
    }

    li td ul li+li {
      margin-top: 4px;
    }

    input,
    select {
      font-size: 14px;
      line-height: 18px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 7px 10px;
      margin-right: 4px;
    }

    td button {
      cursor: pointer;
      display: inline-block;
      vertical-align: middle;
      margin: 0;
      border: none;
      font-size: 16px;
      padding: 7px 10px;
    }

    .btn-add {
      background-color: #86e1ff;
      border-top: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      border-left: 1px solid #ccc;
      border-top-left-radius: 5px;
      border-bottom-left-radius: 5px;
    }

    .btn-del {
      border-top: 1px solid #ccc;
      border-right: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      border-top-right-radius: 5px;
      border-bottom-right-radius: 5px;
      margin-right: 4px;
    }

    td button:hover {
      background-color: #eee;
      color: #333;
    }
  </style>
</head>

<body>
  <div id="outer-container">
    <form id="top-level-props-form">
      <div>
        <table id="top-level-props">
          <tr>
            <td><label for="base-uri">Config base URI:</label></td>
            <td><input id="base-uri" name="base-uri"></td>
          </tr>
          <tr>
            <td><label for="db">Database:</label></td>
            <td><input id="db" name="db"></td>
          </tr>
          <tr>
            <td><label for="reviewer">Reviewer:</label></td>
            <td><input id="reviewer" name="reviewer"></td>
          </tr>
        </table>
      </div>
      <div>
        <button id="submit-top-level-props" type="submit">Save</button>
      </div>
    </form>
  </div>
  <script type="text/javascript">
    (function () {
      let configs = null;

      let sel = (selector, source = document) => {
        return source.querySelector(selector);
      }

      let setConfigVal = (el, new_val, overrideVal) => {
        if (overrideVal || el.dataset.savedVal === undefined || el.dataset.savedVal === el.value) {
          el.value = new_val || '';
          el.dataset.savedVal = el.value;
        } else if (new_val === el.value) {
          el.dataset.savedVal = new_val
        }
      };

      let setConfigVals = (cfgs, overrideVals) => {
        let yaml = cfgs['yaml-config'];
        let set = (k) => {
          setConfigVal(sel('#' + k), yaml[k], overrideVals);
        }
        set('base-uri');
        set('db');
        set('reviewer');
      };

      /// https://jsonpatch.com/
      let getJsonPatch = () => {
        let patch = [];
        let els = [
          sel('#base-uri'),
          sel('#db'),
          sel('#reviewer')
        ];
        for (el of els) {
          let v = el.value.trim();
          if (el.dataset.savedVal != v) {
            let op = 'replace';
            if (!el.dataset.savedVal) op = 'add';
            if (v === '') op = 'remove';
            patch.push({
              'op': op,
              'path': '/' + el.id,
              'value': el.value,
            });
          }
        }

        return patch;
      }

      let saveConfig = (event) => {
        event.preventDefault();
        let patch = getJsonPatch();
        if (patch.length) {
          let req = new XMLHttpRequest();
          req.addEventListener("load", function (resp) {
            loadConfigs(true)
          });
          req.open("PATCH", "/srvc/patch-config");
          req.setRequestHeader("Content-Type", "application/json-patch+json");
          req.send(JSON.stringify(patch));
        }
      };

      let loadConfigs = (overrideVals) => {
        configs = new Promise((resolve, reject) => {
          let req = new XMLHttpRequest();
          req.addEventListener("load", function (resp) {
            let cfgs = JSON.parse(req.response);
            resolve(cfgs);
            setConfigVals(cfgs, overrideVals);
          });
          req.open("GET", "/srvc/configs");
          req.send();
        });
      };

      loadConfigs();
      setInterval(loadConfigs, 500)

      sel('#submit-top-level-props').addEventListener('click', saveConfig);
    })();
  </script>
</body>

</html>
